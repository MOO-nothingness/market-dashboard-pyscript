<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨ ì‹œì¥ ë¶„ìœ„ê¸° ëŒ€ì‹œë³´ë“œ (GitHub Pages) âœ¨</title>
    <!-- PyScript ë¡œë“œ -->
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <!-- CSS ë§í¬ -->
    <link rel="stylesheet" href="style.css">
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
</head>
<body>
    <div class="container">
        <header>
            <h1>âœ¨ ì‹œì¥ ë¶„ìœ„ê¸° ëŒ€ì‹œë³´ë“œ (PyScript) âœ¨</h1>
            <p class="date" id="current-time">ë¡œë”© ì¤‘...</p>
            <p class="warning">
                <span class="material-symbols-outlined">warning</span>
                ë‹¨ìˆœ ì°¸ê³ ìš©ì´ë©°, ì‹¤ì œ íˆ¬ì ê²°ì •ì˜ ê·¼ê±°ë¡œ ì‚¬ìš©ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„° ì§€ì—°/ì˜¤ë¥˜ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
        </header>

        <section class="overall-assessment-section">
            <div id="overall-assessment-card" class="overall-assessment neutral"> <!-- ê¸°ë³¸ ì¤‘ë¦½ ìƒíƒœ -->
                <div class="assessment-score">
                    <span>ì¢…í•© ì ìˆ˜</span>
                    <strong id="total-score" class="score-value">?</strong>
                </div>
                <div class="assessment-text">
                    <h2 id="overall-assessment-text">ë°ì´í„° ë¡œë”© ì¤‘...</h2>
                    <p id="overall-explanation" class="explanation">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>
                </div>
            </div>
        </section>

        <section class="indicators-section">
            <h2><span class="material-symbols-outlined">monitoring</span> ê°œë³„ ì§€í‘œ ë¶„ì„</h2>
            <!-- ì§€í‘œ ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ì˜ì—­ -->
            <div id="indicators-grid" class="indicators-grid">
                <p id="loading-message">ì§€í‘œ ë°ì´í„°ë¥¼ ë¡œë”©í•˜ê³  ë¶„ì„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
        </section>

        <footer>
            <p class="last-updated">ë°ì´í„°ëŠ” í˜ì´ì§€ ë¡œë“œ ì‹œì ì— ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</p>
        </footer>
    </div>

    <!-- PyScript ì„¤ì • ë° Python ì½”ë“œ -->
    <py-config>
        # ì‚¬ìš©í•  Python íŒ¨í‚¤ì§€ ëª…ì‹œ (Pyodide/PyScriptê°€ ì§€ì›í•˜ëŠ” ê²ƒë“¤)
        packages = ["requests", "pandas"]
    </py-config>

    <py-script>
        import asyncio # ë¹„ë™ê¸° HTTP ìš”ì²­ ìœ„í•´
        import json
        from datetime import datetime
        import pandas as pd # í•„ìš” ì‹œ ë°ì´í„° ì²˜ë¦¬
        from pyodide.http import pyfetch # ë¸Œë¼ìš°ì € ë‚´ì¥ fetch ì‚¬ìš©
        from js import document # JavaScript DOM ê°ì²´ ì ‘ê·¼

        # --- 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ (PyScript í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •) ---

        async def fetch_fear_greed():
            """ Alternative.me APIë¥¼ ì‚¬ìš©í•˜ì—¬ Fear & Greed Index ê°€ì ¸ì˜¤ê¸° """
            api_url = "https://api.alternative.me/fng/?limit=1&format=json" # format ëª…ì‹œ
            print("Fetching Fear & Greed...")
            try:
                response = await pyfetch(url=api_url, method="GET")
                if response.ok: # status code 200-299
                    data = await response.json()
                    if data and 'data' in data and len(data['data']) > 0:
                        print("Fear & Greed data fetched successfully.")
                        return int(data['data'][0]['value']), None
                    else:
                        return None, "F&G ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜"
                else:
                    return None, f"F&G API ì˜¤ë¥˜ (ìƒíƒœ: {response.status})"
            except Exception as e:
                print(f"Error fetching Fear & Greed: {e}")
                return None, f"F&G ìš”ì²­ ì˜¤ë¥˜: {e}"

        # ì°¸ê³ : yfinance, fredapi ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ ì‚¬ìš© ë¶ˆê°€!
        # í•„ìš”í•œ ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ ê³µê°œ API ë˜ëŠ” ë‹¤ë¥¸ ìˆ˜ë‹¨ì„ ì‚¬ìš©í•´ì•¼ í•¨.
        # ì˜ˆì‹œë¡œ VIXëŠ” êµ¬í˜„ì´ ë³µì¡í•˜ì—¬ ì œê±°í•˜ê³ , ê°„ë‹¨í•œ ì§€í‘œ ìœ„ì£¼ë¡œ êµ¬ì„±.

        # --- 2. ë°ì´í„° ë¶„ì„ í•¨ìˆ˜ (analyzer.py ë‚´ìš© í†µí•© ë° ìˆ˜ì •) ---

        def analyze_indicator_pyscript(name, value, error_msg=None, **kwargs):
            """ PyScript í™˜ê²½ì—ì„œ ê°œë³„ ì§€í‘œ ë¶„ì„ """
            status, score, color_class, display_value, explanation = "N/A", 0, "neutral", "N/A", "ë°ì´í„° ë¶„ì„ ì¤‘..."
            final_error = error_msg

            if final_error:
                status, display_value, color_class, explanation, score = f"ì˜¤ë¥˜: {final_error}", "ì˜¤ë¥˜", 'error', "ë°ì´í„° ì˜¤ë¥˜ ë°œìƒ", 0
            elif value is None: # ê°’ì´ ì—†ëŠ” ê²½ìš° (í•„ìˆ˜ ê°’ ì§€í‘œ)
                status, display_value, color_class, explanation, score = 'ë°ì´í„° ì—†ìŒ', 'N/A', 'neutral', "ê´€ë ¨ ë°ì´í„° ì—†ìŒ", 0
            else:
                try:
                    # ì˜ˆì‹œ: Fear & Greed ë¶„ì„
                    if name == "Fear & Greed":
                        explanation = "ì‚¬ëŒë“¤ì˜ ì‹œì¥ ì‹¬ë¦¬ ìƒíƒœ (ê³µí¬ vs íƒìš•). ë„ˆë¬´ í•œìª½ìœ¼ë¡œ ì¹˜ìš°ì¹˜ë©´ ë°˜ëŒ€ ì‹ í˜¸?"
                        display_value = str(int(value))
                        if int(value) < 25: status, score, color_class = "ë§¤ìˆ˜ ê³ ë ¤? (ê·¹ë‹¨ì  ê³µí¬)", 1, 'positive'
                        elif int(value) > 75: status, score, color_class = "ë§¤ë„ ê³ ë ¤? (ê·¹ë‹¨ì  íƒìš•)", -1, 'negative'
                        else: status, score, color_class = "ì¤‘ë¦½ì ", 0, 'neutral'

                    # --- ì—¬ê¸°ì— ë‹¤ë¥¸ ì§€í‘œ ë¶„ì„ ë¡œì§ ì¶”ê°€ ---
                    # ì˜ˆì‹œ: ë§Œì•½ ë‹¤ë¥¸ APIë¡œ VIX ê°’ì„ ê°€ì ¸ì™”ë‹¤ë©´...
                    # elif name == "Volatility (VIX)":
                    #    explanation = "ì‹œì¥ì˜ ë¶ˆì•ˆ ì •ë„ë¥¼ ë‚˜íƒ€ë‚´ìš”."
                    #    display_value = f"{float(value):.2f}"
                    #    if float(value) > 25: status, score, color_class = "ì£¼ì˜ (ë¶ˆì•ˆ ë†’ìŒ)", -1, 'negative'
                    #    elif float(value) < 15: status, score, color_class = "ì•ˆì •ì ", 1, 'positive'
                    #    else: status, score, color_class = "ì¤‘ë¦½ì ", 0, 'neutral'

                    # ... (ë‹¤ë¥¸ ì§€í‘œ ë¶„ì„ ë¡œì§ ì¶”ê°€ - API ì œì•½ ê³ ë ¤) ...

                    else: # ì •ì˜ë˜ì§€ ì•Šì€ ì§€í‘œ
                         display_value = str(value)
                         status = "ë¶„ì„ ë¶ˆê°€"
                         explanation = "ì´ ì§€í‘œëŠ” í˜„ì¬ ë¶„ì„ ë¡œì§ì´ ì—†ì–´ìš”."

                except Exception as e:
                    status, display_value, color_class, explanation, score = f"ë¶„ì„ ì˜¤ë¥˜: {e}", 'ì˜¤ë¥˜', 'error', "ë°ì´í„° ë¶„ì„ ì¤‘ ì˜¤ë¥˜", 0
                    final_error = str(e)

            if final_error or status == 'ë°ì´í„° ì—†ìŒ': score = 0

            return {'name': name, 'value': display_value, 'status': status, 'score': score, 'color_class': color_class, 'error': final_error, 'explanation': explanation}

        def get_overall_assessment_pyscript(total_score, num_indicators):
            """ ì¢…í•© ì ìˆ˜ ê¸°ë°˜ ìµœì¢… í‰ê°€ (analyzer.pyì™€ ìœ ì‚¬) """
            if num_indicators == 0:
                return "ë°ì´í„° ë¶€ì¡±", 'neutral', "ë¶„ì„ ê°€ëŠ¥í•œ ìœ íš¨ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."

            positive_threshold = max(1, num_indicators // 3) # ê¸°ì¤€ ì™„í™”
            negative_threshold = -max(1, num_indicators // 3)

            if total_score >= positive_threshold:
                assessment, color_class, explanation = "ì‹œì¥ ë¶„ìœ„ê¸°: ê¸ì •ì  ìš”ì†Œ ìš°ì„¸ ğŸ˜Š", 'positive', "ì¢…í•©ì ìœ¼ë¡œ ê¸ì •ì ì¸ ì‹ í˜¸ê°€ ë§ì•„ ë³´ì…ë‹ˆë‹¤."
            elif total_score <= negative_threshold:
                assessment, color_class, explanation = "ì‹œì¥ ë¶„ìœ„ê¸°: ì£¼ì˜ í•„ìš” ìš”ì†Œ ìš°ì„¸ ğŸ˜Ÿ", 'negative', "ì£¼ì˜ê°€ í•„ìš”í•œ ì‹ í˜¸ê°€ ìƒëŒ€ì ìœ¼ë¡œ ë§ìŠµë‹ˆë‹¤."
            else:
                assessment, color_class, explanation = "ì‹œì¥ ë¶„ìœ„ê¸°: ì¤‘ë¦½ì  / í˜¼ì¡° ğŸ¤”", 'neutral', "ê¸ì •/ë¶€ì • ì‹ í˜¸ê°€ í˜¼ì¬ë˜ì–´ ë°©í–¥ì„± ëª¨í˜¸."

            return assessment, color_class, explanation

        # --- 3. HTML ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---

        def create_indicator_card_html(result):
            """ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ HTML ì¹´ë“œ ë¬¸ìì—´ ìƒì„± """
            error_html = f"""
            <div class="card-footer error-message">
               <span class="material-symbols-outlined">error</span> ì˜¤ë¥˜: {result['error']}
            </div>
            """ if result['error'] else ""

            return f"""
            <div class="indicator-card {result['color_class']}">
                <div class="card-header">
                    <h3 class="indicator-name">{result['name']}</h3>
                    <span class="indicator-score">({result['score']})</span>
                </div>
                <div class="card-body">
                    <p class="indicator-value">{result['value']}</p>
                    <p class="indicator-status">{result['status']}</p>
                    <p class="indicator-explanation">
                        <span class="material-symbols-outlined">help_outline</span>
                        {result['explanation']}
                    </p>
                </div>
                {error_html}
            </div>
            """

        def update_dashboard(analysis_results, total_score, overall_assessment, overall_color_class, overall_explanation):
            """ ë¶„ì„ ê²°ê³¼ë¡œ HTML ëŒ€ì‹œë³´ë“œ ë‚´ìš© ì—…ë°ì´íŠ¸ """
            # í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
            now = datetime.now()
            document.getElementById("current-time").innerText = f"ê¸°ì¤€ ì‹œê°„: {now.strftime('%Y-%m-%d %H:%M:%S')}"

            # ì¢…í•© í‰ê°€ ì—…ë°ì´íŠ¸
            overall_card = document.getElementById("overall-assessment-card")
            overall_card.className = f"overall-assessment {overall_color_class}" # í´ë˜ìŠ¤ ë³€ê²½ìœ¼ë¡œ ë°°ê²½ìƒ‰ ì ìš©
            document.getElementById("total-score").innerText = str(total_score)
            document.getElementById("overall-assessment-text").innerText = overall_assessment
            document.getElementById("overall-explanation").innerText = overall_explanation

            # ê°œë³„ ì§€í‘œ ì¹´ë“œ ì—…ë°ì´íŠ¸
            grid = document.getElementById("indicators-grid")
            grid.innerHTML = "" # ê¸°ì¡´ ë‚´ìš© ì‚­ì œ
            if not analysis_results:
                grid.innerHTML = "<p>ë¶„ì„í•  ì§€í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>"
                return

            for result in analysis_results.values():
                 card_html = create_indicator_card_html(result)
                 grid.innerHTML += card_html # ìƒì„±ëœ HTML ì¶”ê°€

            # ë¡œë”© ë©”ì‹œì§€ ì œê±° (í•„ìš” ì‹œ)
            loading_msg = document.getElementById("loading-message")
            if loading_msg:
                loading_msg.style.display = 'none'


        # --- 4. ë©”ì¸ ì‹¤í–‰ ë¡œì§ (ë¹„ë™ê¸°) ---

        async def main():
            print("Dashboard update started...")
            analysis_results = {}
            total_score = 0
            num_valid_indicators = 0

            # ë°ì´í„° ë³‘ë ¬ ë¡œë”© ì‹œë„ (ì—¬ê¸°ì„œëŠ” ìˆœì°¨ì  ì˜ˆì‹œ)
            fng_value, fng_err = await fetch_fear_greed()
            # ë‹¤ë¥¸ ë¹„ë™ê¸° ë°ì´í„° ë¡œë”© í•¨ìˆ˜ í˜¸ì¶œ...
            # vix_value, vix_err = await fetch_vix_somehow()

            # ë¶„ì„í•  ë°ì´í„° ì •ì˜ (API ì œì•½ ê³ ë ¤)
            indicators_data = {
                "Fear & Greed": {'value': fng_value, 'error': fng_err},
                # "Volatility (VIX)": {'value': vix_value, 'error': vix_err}, # ì˜ˆì‹œ
                # ... ë” ë§ì€ ì§€í‘œ ë°ì´í„° ...
            }

            # ê° ì§€í‘œ ë¶„ì„
            for name, data in indicators_data.items():
                # í˜„ì¬ëŠ” ì¶”ê°€ kwargs ì—†ìŒ
                result = analyze_indicator_pyscript(name, data.get('value'), data.get('error'))
                analysis_results[name] = result
                if result.get('error') is None and result.get('status') != 'ë°ì´í„° ì—†ìŒ':
                    total_score += result.get('score', 0)
                    num_valid_indicators += 1

            # ì¢…í•© í‰ê°€
            overall_assessment, overall_color_class, overall_explanation = get_overall_assessment_pyscript(total_score, num_valid_indicators)

            # HTML ì—…ë°ì´íŠ¸
            update_dashboard(analysis_results, total_score, overall_assessment, overall_color_class, overall_explanation)
            print("Dashboard update finished.")

        # ë¹„ë™ê¸° ë©”ì¸ í•¨ìˆ˜ ì‹¤í–‰
        # Pyscript 0.20.0 ì´í›„ await ìµœìƒìœ„ ë ˆë²¨ ì§€ì› í™•ì¸ í•„ìš”, ì•ˆë˜ë©´ asyncio.ensure_future ì‚¬ìš©
        try:
             # asyncio.ensure_future(main()) # êµ¬ë²„ì „ PyScript í˜¸í™˜ì„±
             await main() # ìµœì‹  PyScript ê¶Œì¥ (await ì§ì ‘ ì‚¬ìš©)
        except Exception as e:
             print(f"Error during main execution: {e}")
             # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
             grid = document.getElementById("indicators-grid")
             grid.innerHTML = f"<p style='color:red;'>ëŒ€ì‹œë³´ë“œ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}</p>"
             loading_msg = document.getElementById("loading-message")
             if loading_msg: loading_msg.style.display = 'none'


    </py-script>
</body>
</html>
